title: encrypt
signatures:
  - inputs: [ key, nonce&, plaintext ]
    output: promise
variables:
  key:
    type: "[`SymmetricKey`]() | [`SharedKey`]()"
    description: |
      Key to be used in the encryption operation.
  nonce:
    type: "[`Nonce`]()"
    description: |
      Optional. A value to be combined with the plaintext before encryption. A nonceLength random nonce is generated if not supplied.
  plaintext:
    type: "[`Plaintext`]()"
    description: The plaintext to be encrypted.
  promise:
    isPromised: true
    type: "[`Envelope`]()"
    description: |
      Promise that resolves to an [`Envelope`], an object with properties ciphertext and nonce. Suitable for use with decrypt.

prose: |
  A [generic function]() accepting an encryption key and plaintext to output a ciphertext [`Envelope`]().  `encrypt` and its counterpart [`decrypt`]() form a pair of opposing operations.

  Panda-Confidential establishes a type system to determine your intention in a clear and error-free way.  That allows `encrypt`'s behavior to depend on the input key:
   - When given a [`SymmetricKey`](), `encrypt` uses [symmetric encryption]() and requires a nonce `nacl.secretbox.nonceLength` bytes long if you provide `nonce`.
   - When given a [`SharedKey`](), `encrypt` uses authenticated, [asymmetric encryption]() and requires a nonce `nacl.box.nonceLength` bytes long if you provide `nonce`.

  > **Warning**: Signing key pairs are incompatible with `encrypt` and will cause `encrypt` to throw.

  `encrypt` expects its input to be an instance of `Plaintext`, a special container that keeps your data typed and formmated properly for `encrypt`.  To convert your data into an instance of `Plaintext`, use the static method `Plaintext.from`.

  `encrypt` accepts an optional `nonce` as its second argument, or will generate its own from the [`randomBytes`]() interface if it is omitted.

  `encrypt` returns a promise that yields [`Envelope`](), a special container for the resultant ciphertext.  This container is expected by [`decrypt`]().

examples:
  - title: Symmetric Encryption
    note: |
      **Warning**: Private keys should only be accessible to their owners.
    content: |
      ```coffeescript
      import assert from "assert"
      import {confidential} from "panda-confidential"
      {encrypt, Plaintext} = confidential()
      import {keyLookup, write} from "my-library"

      do ->
        alice = keyLookup "Alice/private"
        plaintext = Plaintext.from "utf8", "Hello, Alice!"
        envelope = await encrypt alice, plaintext
        # serialize as needed with convert
        write "greeting", envelope.to "base64"
      ```

  - title: Asymmetric Encryption
    note: |
      **Warning:** Private keys should only be accessible to their owners.
    content: |
      ```coffeescript
      import assert from "assert"
      import {confidential} from "panda-confidential"
      {SharedKey, encrypt, Plaintext} = confidential()
      import {keyLookup, send} from "my-library"

      do ->
        alice = keyLookup "Alice/private"
        bob = keyLookup "Bob/public"
        fromAliceToBob = sharedKey.create alice, bob
        plaintext = Plaintext.from "utf8", "Hello, Bob!"
        envelope = await encrypt fromAliceToBob, plaintext
        send "Bob", envelope.to "base64"
      ```
